<!DOCTYPE html>
<!-- OLD
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="lazy-import.html">
-->

<!-- Load webcomponents-loader.js to check and load any polyfills your browser needs -->
<script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<script src="bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/polymerfire/firebase-app.html">
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/polymerfire/firebase-document.html">
<link rel="import" href="bower_components/polymerfire/firebase-query.html">
<link rel="import" href="bower_components/polymerfire/firebase-messaging.html">

<link rel="import" href="bower_components/paper-card/paper-card.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/device-icons.html">
<link rel="import" href="bower_components/iron-icons/av-icons.html">
<link rel="import" href="bower_components/iron-icons/editor-icons.html">
<link rel="import" href="bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="bower_components/iron-icons/image-icons.html">
<link rel="import" href="bower_components/iron-icons/maps-icons.html">
<link rel="import" href="bower_components/iron-icons/notification-icons.html">
<link rel="import" href="bower_components/iron-icons/social-icons.html">
<link rel="import" href="bower_components/iron-icons/places-icons.html">
<link rel="import" href="bower_components/iron-image/iron-image.html">

<link rel="import" href="bower_components/paper-pulsating-progress/paper-pulsating-progress.html">

<dom-module id="dialog-html">
  <template is="dom-bind">
    <style include="shared-styles">
    :host {
        @apply(--layout-vertical);
        @apply(--layout-center);
        margin: 0 auto;
        text-align: center;
        margin: 0 auto;
    }

    :host(.horizontal) {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        @apply(--layout-around-justified);
        max-width: inherit;
    }

      a:visited { text-decoration:none; }
      a:active { text-decoration:none; }
      a:link { text-decoration:none; }

      #notes {
        @apply --layout-vertical;
        @apply --layout-wrap;
      }

      #notes > paper-card {
        --paper-card-background-color: #f3f3f3;
        box-sizing: border-box;
        margin: 1px 1px 1px 1px;
      }

      #notes > paper-card.magenta {
        --paper-card-background-color: #e02871;
        box-sizing: border-box;
        margin:  1px 1px 1px 1px;
      }

      #notes > paper-card.darkgrey {
        --paper-card-background-color: #c3c4cc;
        box-sizing: border-box;
        margin:  1px 1px 1px 1px;
      }

      #notes > paper-card.lightgrey {
        --paper-card-background-color: #ffffff;
        box-sizing: border-box;
        margin:  1px 1px 0px 1px;
      }

      a paper-button,
      a:hover paper-button,
      a:link paper-button,
      a:active paper-button,
      a:visited paper-button {
        color: #000;
        text-transform: none;
        text-decoration: none;
      }

      a:visited { text-decoration:none; }
      a:active { text-decoration:none; }
      a:link { text-decoration:none; }

    </style>

    <firebase-messaging
            id="messaging"
            token="{{token}}"
            on-message="handleMessage">
    </firebase-messaging>

    <firebase-document path="/users/[[user.uid]]/token" data="[[token]]">
    </firebase-document>

        <paper-icon-button icon="icons:more-vert" slot="top" on-tap="hire"></paper-icon-button>

        <paper-dialog id="dialog" backdrop transition="core-transition-bottom">

          <div id="notes">

            <paper-card class="magenta">
              <div style="float:left; width:100%" class"box">
                <div id="leftThing" style="float:left; width:25%;">
                  <paper-icon-button id="dashboard-icon-button" mini slot="top" icon="icons:grain" style="color: white;"></paper-icon-button>
                </div>
                  <div id="leftThing" slot="top" style="float:left; width:50%;" style="text-align: center">
                    <template is="dom-if" if="[[signedin]]">
                            <h4 style='color: white;'>[[user.displayName]]</h4>
                      </template>
                    <template is="dom-if" if="[[!signedin]]">
                          <h4 style='color: white;'>--&nbsp;&nbsp;&nbsp;&nbsp;Sign In&nbsp;&nbsp;&nbsp;&nbsp;--</h4>
                    </template>
                  </div>
                <div id="rightThing" style="float:right; width:25%;">
                  <paper-icon-button id="dashboard-icon-button" mini slot="top" icon="icons:grain" style="color: white;"></paper-icon-button>
              </div>
            </div>
            </paper-card>


            <paper-card class="lightgrey">
              <template is="dom-if" if="[[signedin]]">
                    <div style="float:left; width:100%">
                        <div><h4><u>Notifications:</u></h4></div>
                        <div style="float:center;">
                          <paper-toggle-button on-tap="toggleNotifications" checked="[[token]]">
                          <!-- instead of token you can use a seperate value isSubscribed of model -->
                            Receive Notifications</paper-toggle-button>
                          </div>
                        <iron-icon></iron-icon>
                        <div>
                              <div style="text-align: left">
                                  If this option is deselected, I understand I won't be notified when:
                                  <li>Changes occur in backend</li>
                                  <li>Transactions added to dashboard</li>
                              </div>
                              <iron-icon></iron-icon>
                              <div style="text-align: left">
                                  <b>Note:</b> Notifications are activated per device. To receive notifications on multiple devices,
                                  sign in on each device, enable notifications, and make sure you're online.
                                  <!-- <p>Token is = [[token]]</p> -->
                              </div>
                              <div style="text-align: center">
                                <a href="/settings-page">
                                    <paper-button dialog-confirm autofocus >
                                        <iron-icon icon="icons:select-all"></iron-icon><h4>Settings</h4>
                                    </paper-button>
                                  </a>
                                </div>
                        </div>
            </template>
            <template is="dom-if" if="[[!signedin]]">
                  <div style="float:left; width:100%">
                    <div class="circle">
                        <iron-icon icon="icons:remove-circle" style="color: #e02871;"></iron-icon>
                    </div>
                      <div><h4><u>You are not Signed In:</u></h4></div>
                        <div>
                            <div style="text-align: left">
                                In order to view your notes, sign in to the app using your credentials:
                                  <li>Tap on top right icon to sign in</li>
                                  <li>Go to settings page and sign in</li>
                            </div>
                            <iron-icon></iron-icon>
                            <div style="text-align: left">
                                <b>Note:</b> Notifications are activated per device. To receive notifications on multiple devices,
                                sign in on each device, enable notifications, and make sure you're online.
                            </div>
                        <div>
                      <div style="text-align: center">
                        <a href="/settings-page">
                            <paper-button dialog-confirm autofocus >
                                <iron-icon icon="icons:select-all"></iron-icon><h4>Settings</h4>
                            </paper-button>
                          </a>
                        </div>
                  </div>
            </template>
            </paper-card>

            <paper-card class="magenta">
              <div style="float:left; width:100%">
                <div id="leftThing0" style="float:left; width:25%;" >
                      <paper-icon-button id="dashboard-icon-button0" dialog-dismiss slot="top" icon="icons:dashboard" style="color: white;"></paper-icon-button>
                  </div>
                  <div id="leftThing1" style="float:left; width:25%;">
                    <paper-icon-button id="transactions-icon-button1" dialog-dismiss slot="top" icon="icons:gavel" style="color: white;"></paper-icon-button>
                  </div>
                <div id="leftThing2" style="float:left; width:25%;">
                    <paper-icon-button id="payments-icon-button2" dialog-dismiss slot="top" icon="icons:select-all" style="color: white;"></paper-icon-button>
                </div>
                <div id="leftThing3" style="float:right; width:25%;">
                      <paper-icon-button id="reports-icon-button3" on-tap="hire" slot="top" icon="icons:line-style" style="color: white;"></paper-icon-button>
                </div>
              </div>
            </paper-card>

          </div>

        </paper-dialog>
  </template>
  <script>
      class DailogHTML extends Polymer.Element {
            static get is() { return 'dialog-html'; }

            static get properties() {
              return {
                user: { type: Object, notify: true, readOnly: false, observer: '_userChanged' },
                signedin: { type: Boolean, notify: true, readOnly: false, observer: '_signedinChanged' },
                statusKnown: { type: Boolean, notify: true, readOnly: false, observer: '_statusChanged' }
              };
            }

            _userChanged(user){
              this.$.user = user;
              //this.$.user.value = user;
            }

            _signedinChanged(signedin){
              this.$.signedin = signedin;
            }

            _statusChanged(statusKnown){
              this.$.statusKnown = statusKnown;
            }

            hire(e) {
              if(this.signedin)
                console.log('user ->'+this.user.displayName);
              else
                console.log('user is null or undefined->'+this.signedin);
              this.$.dialog.toggle();
            }

            gosettings(e) {
              //toggle off the dialog box
              this.$.dialog.toggle();
              //send the response to settings page
            }

            toggleNotifications(){
              var userName = this.user.displayName;
              var tokenVal = this.token;
              console.log('inside toggleNotifications()');
              this.$.messaging.requestPermission().then(function() {
                  // permission was granted
                  //you can now store the user if subscribed or not subscribed
                  console.log('permission was granted!'+ userName);
                  console.log('[[token]] ->' + tokenVal);
                }, function(err) {
                  // permission was denied
                  console.log('Error ->'+ err);
                });
            }

            handleMessage(){
              console.log('message received '+ JSON.stringify(arguments));
              document.getElementById('toast').show('User notification turned on!');
              /* arguments object in JSON.stringify
              {
              	"0": {
              		"isTrusted": false,
              		"detail": {
              			"message": {
              				"from": "531391633867",
              				"collapse_key": "do_not_collapse",
              				"notification": {
              					"title": "Hello World",
              					"body": "This is notification!"
              				}
              			}
              		}
              	},
              	"1": {
              		"message": {
              			"from": "531391633867",
              			"collapse_key": "do_not_collapse",
              			"notification": {
              				"title": "Hello World",
              				"body": "This is notification!"
              			}
              		}
              	}
              }
              */

            }

            /******* HOW to call notifications from postman or API  ***************
                Postman request to send notifications to users
                POST https://fcm.googleapis.com/fcm/send

                Content-Type: application/json
                Authorization: key=AAAAe7lo2cs:APA91bF9HmWWZ0p96s4loxqJARfW_Em_kRCSYIgtrbLwmz787tQU9izCdkfaxSuXaO28uZ-Q56E7fJukbMampUr7GNcfS1ga9tY27pNlrySEFeFMxGU8Y3J0KtOtlEhMrAcX1pUDIeTA

                <!-- note that key=app msg key in cloud services is necessary -->
                Body: Option "Raw"

                	{
                	"registration_ids" : [
                			"ffDZUQ2Gym4:APA91bEpSBToe7K8CtzoY3DKBQlz707NbHBu1LI0IXyyzeuOBEdtfg78XAai44FU3UXFhhZlWNtAq7dzxxIR0bdjoG0FQDl3pWRidoDFeosSI32_Kel7W5NT6MIUG7IVSn2uK-26N_Ux",
                			"ckXsMGcYVW8:APA91bG0YURynUx5HLqHVxq_aFmvHryvlaNQc03T9WQf9vaPG-yWc_fUm0gypYNMW2GWXv8L6gg6qAmrZaLGi0KMeY3DUsW5zJsp3UEtr1WpbtlIwAAIC_onA4cFY8Sj66DXDLxz5Ko8",
                			"ekkKE1j-uIc:APA91bFTrZNcKLreauaupqdkxCtr8LUt8lGakLUQzLxEt9tDHH2_4kklsO_PSEA4Oa9PBrSMUYXGUM4AN9QY092Wb3A7kdixVx67K9AkGbEGV3RQfj-qQGSX3fhlHn21znrzBP6Yj5F9"
                			],
                  	"notification" :
                  	{
                  		"title" : "Hello World",
                  		"body"	: "this is notification!"
                  	}
                }

                // the output of the POSTman request
                {
                    "multicast_id": 7721873443091050692,
                    "success": 2,
                    "failure": 1,
                    "canonical_ids": 0,
                    "results": [
                        {
                            "message_id": "0:1507007444546704%0f493ae6f9fd7ecd"
                        },
                        {
                            "error": "NotRegistered"
                        },
                        {
                            "message_id": "0:1507007444613363%e609af1cf9fd7ecd"
                        }
                    ]
                }

                // if you want service worker to intercept then send msg using data :
                {
                	"registration_ids" : [
                			"ffDZUQ2Gym4:APA91bEpSBToe7K8CtzoY3DKBQlz707NbHBu1LI0IXyyzeuOBEdtfg78XAai44FU3UXFhhZlWNtAq7dzxxIR0bdjoG0FQDl3pWRidoDFeosSI32_Kel7W5NT6MIUG7IVSn2uK-26N_Ux",
                			"ckXsMGcYVW8:APA91bG0YURynUx5HLqHVxq_aFmvHryvlaNQc03T9WQf9vaPG-yWc_fUm0gypYNMW2GWXv8L6gg6qAmrZaLGi0KMeY3DUsW5zJsp3UEtr1WpbtlIwAAIC_onA4cFY8Sj66DXDLxz5Ko8",
                			"ekkKE1j-uIc:APA91bFTrZNcKLreauaupqdkxCtr8LUt8lGakLUQzLxEt9tDHH2_4kklsO_PSEA4Oa9PBrSMUYXGUM4AN9QY092Wb3A7kdixVx67K9AkGbEGV3RQfj-qQGSX3fhlHn21znrzBP6Yj5F9"
                			],
                	"data" : {
                		"notification" :
                				{
                					"title" : "Hello World",
                					"body"	: "This is notification!"
                				}
                		}

                }
            ****************/
          }
      window.customElements.define(DailogHTML.is, DailogHTML);
  </script>
</dom-module>
